/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var grass = /* color: #dde026 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.62259908319089, 45.014022375149935],
             [-89.62257494330976, 45.01398255611301],
             [-89.62254007459256, 45.01395601007299],
             [-90.33764578986013, 45.006421437268536],
             [-90.33835389304006, 45.006118013167615],
             [-90.32099783504884, 45.0085835852891],
             [-90.32106757248323, 45.00842808650779],
             [-90.32083690250795, 45.00836740394203],
             [-90.316703618416, 45.00838447092015],
             [-90.3158560403673, 45.00827069096996],
             [-90.31702548349779, 45.00824793495281],
             [-90.3251874455301, 45.00630700305379],
             [-90.3251338013498, 45.006326915243996],
             [-90.32508418048303, 45.00634682742728],
             [-90.32512039030473, 45.00637811798703],
             [-90.32524377191942, 45.0063657914049],
             [-90.32570377076547, 45.00639897835069],
             [-90.32566353763025, 45.00638854816981],
             [-90.32559245909135, 45.00636863600103],
             [-90.32557100141923, 45.00633829363529],
             [-90.32544493759553, 45.006305106654345],
             [-90.32575205052774, 45.00624537004025],
             [-90.32573327506464, 45.00631743324952],
             [-90.32572120512407, 45.00635156842227],
             [-90.32575339163225, 45.00619890818619],
             [-90.29614303547912, 45.007582072378725],
             [-90.28999004799896, 45.00652768808027],
             [-90.29002223450713, 45.0063759765121],
             [-90.28839145142608, 45.00730520356069],
             [-90.28839681584411, 45.00763517035526],
             [-90.28899226624542, 45.00775274427104],
             [-90.28893325764709, 45.00778308588753],
             [-90.28908346135192, 45.00779446398958],
             [-90.28902981717162, 45.00774895156784]]),
        {
          "class_2017": 0,
          "system:index": "0"
        }),
    impervious = /* color: #ff0000 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.61528282574211, 45.01797068807322],
             [-89.61497168949639, 45.01797448009954],
             [-89.61469273975884, 45.017989648202324],
             [-89.61372714451348, 45.01784555106377],
             [-89.61564224175011, 45.02024585873801],
             [-89.6156046908239, 45.01997284303166],
             [-90.34318186926687, 45.00437329339733],
             [-90.34328915762747, 45.00417606086292],
             [-90.32577082599084, 45.00618658156552],
             [-90.32576680267732, 45.00623873263483],
             [-90.32584995115678, 45.00622925062574],
             [-90.32577753151338, 45.00608512389465]]),
        {
          "class_2017": 1,
          "system:index": "0"
        }),
    soil = /* color: #c2ab6a */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-90.19509842881594, 44.767029174361994],
             [-90.20848801621828, 44.7726961059434],
             [-90.18489479543004, 44.76989704195741],
             [-90.15448927403722, 44.775061027926235],
             [-90.15313744069371, 44.77471068359724]]),
        {
          "class_2017": 2,
          "system:index": "0"
        }),
    tree = /* color: #34c058 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.63244815469358, 45.01545015375048],
             [-89.63114996553037, 45.01322030063952],
             [-89.63323135972593, 45.01733863490571],
             [-89.64011927247617, 45.014896490842766],
             [-89.64170714021299, 45.0129851750132],
             [-89.62402870059583, 45.01463672249665],
             [-89.62392409444425, 45.01461965738154],
             [-89.62444980741117, 45.01441297947292],
             [-89.62455977798078, 45.01438832976431],
             [-89.62488432527158, 45.0146424108672],
             [-89.6246536552963, 45.014640514743746],
             [-89.62434520125959, 45.01470308678471],
             [-89.62344129682157, 45.014862360762336],
             [-89.62296922803495, 45.01482254230946],
             [-89.62323476672742, 45.01487563357384],
             [-89.62269296050641, 45.014725840237205],
             [-89.62226112485502, 45.014701190663274],
             [-89.62206264138791, 45.01472015187493],
             [-89.62527860999677, 45.01419871626642],
             [-89.62557365298841, 45.014037544299576],
             [-89.62535907626722, 45.01412666297258],
             [-89.62593038678739, 45.01424991197271],
             [-89.6261664211807, 45.014314380574795],
             [-89.62645341754529, 45.01414752051435],
             [-89.62655534148786, 45.01428404241816],
             [-89.62699790597532, 45.01411718226929],
             [-89.6270300924835, 45.01369054899616],
             [-89.62659289241407, 45.01358626037932],
             [-89.62603499293897, 45.01347438692465],
             [-89.62539394498441, 45.01344973681203],
             [-89.61065333298241, 45.01463360756462],
             [-89.60967700890099, 45.01496732436675],
             [-89.60894744804894, 45.01455017806022],
             [-89.61461227348839, 45.01392824519732],
             [-89.61386125496422, 45.01351867596489],
             [-89.61343210152184, 45.01291948606991],
             [-89.60797112396752, 45.01347316809159],
             [-89.6068875115255, 45.01331389025025],
             [-89.60715573242699, 45.01362486086197],
             [-90.32507479275148, 45.0062112348042],
             [-90.32503992403429, 45.00621313120674],
             [-90.32500773752611, 45.00625295564548],
             [-90.32508552158754, 45.0063136404513],
             [-90.32515794123094, 45.00627950525594],
             [-90.32512039030473, 45.006268126852966],
             [-90.3257641204683, 45.00613727505632],
             [-90.32574668610971, 45.0061116735829],
             [-90.32571986401956, 45.00618563336381],
             [-90.32568097198885, 45.006228302424766],
             [-90.32570377076547, 45.00627097145392],
             [-90.32563135112207, 45.00631079585246],
             [-90.32553076828401, 45.00631269225169],
             [-90.32527864063661, 45.006148653485305],
             [-90.32526522959154, 45.00618184055688],
             [-90.3252410897104, 45.006202700992006],
             [-90.32525450075548, 45.006230198826735],
             [-90.32530412162225, 45.00621028660291],
             [-90.28889034230285, 45.00763137764427],
             [-90.28882596928649, 45.00766171932507],
             [-90.28891179997497, 45.0077148172278],
             [-90.28896007973724, 45.00768068286742]]),
        {
          "class_2017": 3,
          "system:index": "0"
        }),
    water = /* color: #2523be */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-90.36288001227224, 45.00693725455157],
             [-90.36277272391165, 45.00827228948008],
             [-90.36169984030569, 45.007210332409215],
             [-90.36054112601126, 45.00698276761825],
             [-90.35923220801199, 45.008894283764306],
             [-90.35908200430715, 45.007255845258925],
             [-90.32095223749559, 45.00857031101936],
             [-90.32103806818407, 45.00850393962458],
             [-90.32090395773332, 45.00838257458951],
             [-90.29483442596701, 45.00432615604225],
             [-90.29596095375327, 45.004398221665895],
             [-90.29558008007315, 45.004466494278354],
             [-90.2954620628765, 45.004208575093266],
             [-90.13123233823143, 44.75900099927324],
             [-90.13130744008384, 44.75868674454283],
             [-90.12664307860695, 44.760764603199966],
             [-90.12657870559059, 44.76017801089249],
             [-90.12378384379707, 44.760082784306675]]),
        {
          "class_2017": 4,
          "system:index": "0"
        });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var wb = ee.Image('users/erker/UTC/marathon_water/water_bodies');
var wl = ee.Image('users/erker/UTC/marathon_water/water_lines');

var classProperty = 'class_2017';

var pts = ee.FeatureCollection('users/erkere/marathonShapefiles/marathon_accuracy_training').remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);

var buf3000 = function(feature) {return feature.buffer(3000)};
var urbanregion = pts.map(buf3000);
var naip = ee.ImageCollection('USDA/NAIP/DOQQ').filterBounds(urbanregion);  
var naip17c = naip.filterDate('2017-01-01', '2017-12-31');
var naip18c = naip.filterDate('2018-01-01', '2018-12-31');


var pts = pts.merge(grass).merge(tree).merge(soil).merge(impervious).merge(water);

var naip17 = naip17c.median().byte();
var naip18 = naip18c.median().byte();



var ndvi = naip17.normalizedDifference(['N', 'R']);
var gauss53 = ee.Kernel.gaussian({radius: 5, sigma: 3, units: 'pixels', normalize:true});
var naip17Gauss53 = naip17.convolve(gauss53);
var naip18Gauss53 = naip18.convolve(gauss53);
var gauss104 = ee.Kernel.gaussian({radius: 10, sigma: 4, units: 'pixels', normalize:true});
var naip17Gauss104 = naip17.convolve(gauss104);
var naip18Gauss104 = naip18.convolve(gauss104);
var win10 = ee.Kernel.square({radius: 10});
var entro10 = naip17.select('N').entropy(win10);
var win5 = ee.Kernel.square({radius: 5});
var entro5 = naip17.select('N').entropy(win5);
var nir17glcm3 = naip17.select(['N']).glcmTexture({size: 3, average: false});
var contrast3 = nir17glcm3.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir17glcm7 = naip17.select(['N']).glcmTexture({size: 7, average: false});
var contrast7 = nir17glcm7.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');

var image = ee.Image.cat([naip17, naip18, ndvi, naip17Gauss53, naip17Gauss104, naip18Gauss104, entro10, entro5, contrast3, contrast7, wb, wl]);

var image = ee.Image.cat([naip17, naip18, naip17Gauss53, entro5, contrast3, wb, wl]);


var training = image.sampleRegions({
  collection: pts,
  properties: [classProperty],
  scale: 1
});
print(training.size());

var trainedClassifier = ee.Classifier.smileRandomForest(10).train({
  features: training,
  classProperty: classProperty,
  inputProperties: image.bandNames()
});

// print(trainedClassifier);

var testpts = ee.FeatureCollection('users/erkere/marathonShapefiles/marathon_accuracy_testing').remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);
var testing = image.sampleRegions({collection: testpts, properties: [classProperty], scale: 1});
var testingClassified = testing.classify(trainedClassifier);
var testAccuracy = testingClassified.errorMatrix('class_2017', 'classification');
print('Testing error matrix: ', testAccuracy);
print('Testing overall accuracy: ', testAccuracy.accuracy());

// var validation = image.sampleRegions({collection: testpts, properties: [classProperty], scale: 1});
// var validationClassified = validation.classify(trainedClassifier);
// var validationAccuracy = validationClassified.errorMatrix('class_2017', 'classification');
// print('Validation error matrix: ', validationAccuracy);
// print('Validation overall accuracy: ', validationAccuracy.accuracy());


var classified = image.classify(trainedClassifier);




// Map.centerObject(pts, 24);
Map.addLayer(naip17);
//Map.addLayer(naip18);
Map.addLayer(classified, {min: 0, max: 4, palette: ['yellow', 'red', 'brown','green','blue']});





// Export.image.toDrive({
//   image: classified,
//   description: 'marathon2017-fullcounty',
//   scale: 1,
//   maxPixels: 12000000000,
//   region: marathonExport,
//   crs: 'EPSG:3070',
// });


// Export.image.toAsset({
//   image: classified,
//   description: 'marathonClassified2017',
//   assetId: 'marathonClassified2017',
//   scale: 1,
//   maxPixels: 12000000000,
//   region: marathonExport,
//   pyramidingPolicy: {
//     'classification': 'mode'
//   }
// });