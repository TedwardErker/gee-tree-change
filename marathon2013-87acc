/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var wb = ee.Image("users/erker/UTC/marathon_water/water_bodies"),
    wl = ee.Image("users/erker/UTC/marathon_water/water_lines"),
    height = ee.Image("users/erker/UTC/marathonHeight/marathon2012Height"),
    grass = /* color: #d6cd2c */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-89.64032470260393, 44.94542239712331],
               [-89.64040382776987, 44.94540626060245],
               [-89.64042528544199, 44.945375885962605],
               [-89.64045747195017, 44.9453531049722],
               [-89.64050306950342, 44.94534456209845],
               [-89.64052720938456, 44.94531513663475],
               [-89.64056073699724, 44.945304695337526],
               [-89.64061438117754, 44.945308492173105],
               [-89.64067473088038, 44.94528760957439],
               [-89.6406438854767, 44.9452752698534],
               [-89.64048429404032, 44.94529425403843]]],
             [[[-89.63991754193128, 44.945210642760024],
               [-89.64009456772627, 44.945109077149034],
               [-89.64007391606104, 44.94502942408994],
               [-89.64003368292582, 44.945111056390715],
               [-89.63985263381731, 44.94515851697732]]],
             [[[-89.64108281605446, 44.94332505141079],
               [-89.64093797676766, 44.94304312594668],
               [-89.64090176694596, 44.94305166916291]]],
             [[[-89.64319805057347, 44.94307701352347],
               [-89.64319402725995, 44.94293747422756],
               [-89.64310551436246, 44.9429403219717],
               [-89.64311087878049, 44.94307701352347]]],
             [[[-89.84094493342377, 44.92867230552891],
               [-89.84094426287152, 44.92864809368428],
               [-89.84101936472393, 44.928612488011886],
               [-89.84098583711125, 44.92858115500188],
               [-89.84095230949856, 44.92856121580482],
               [-89.84086781991459, 44.92855789260463],
               [-89.84085977328755, 44.928612488011886]]]]),
        {
          "class_2013": 0,
          "system:index": "0"
        }),
    soil = /* color: #c3a782 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-89.64080788963044, 44.94305214378601],
               [-89.6408736037513, 44.943049296047434],
               [-89.6409446822902, 44.94303458272921],
               [-89.64099564426148, 44.94300088447003],
               [-89.64096479885781, 44.94298332339755],
               [-89.6407374816438, 44.942864667361626],
               [-89.64072071783745, 44.942874159853496],
               [-89.64097083382809, 44.94300135909352],
               [-89.64087628596032, 44.943026039510436],
               [-89.64081459515297, 44.94301797091378]]],
             [[[-89.85132945647592, 44.933902625559824],
               [-89.85147697797174, 44.933899777367444],
               [-89.85148502459879, 44.93382477491702],
               [-89.85132275095339, 44.93382762311313]]]]),
        {
          "class_2013": 2,
          "system:index": "0"
        }),
    impervious = /* color: #e52828 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-89.64310417325795, 44.943114983341204],
               [-89.64309746773542, 44.94296879940515],
               [-89.64298079164327, 44.94296405316721],
               [-89.64299152047933, 44.94312162805673]]],
             [[[-89.64601354316959, 44.94446597827458],
               [-89.64588479713687, 44.94222576877912],
               [-89.64790181831607, 44.94395719260396],
               [-89.64587406830081, 44.94215742203051],
               [-89.64856700615177, 44.94212704567169],
               [-89.64808420852908, 44.94426853959452],
               [-89.64863137916812, 44.942119451579465],
               [-89.648609921496, 44.944435603137244],
               [-89.64869575218448, 44.944435603137244],
               [-89.64870328457654, 44.942086941661486],
               [-89.64581186325849, 44.94211731804153],
               [-89.64592451603711, 44.94451320438961],
               [-89.64830095322431, 44.94449042305685]]],
             [[[-89.64442299322376, 44.94256939980996],
               [-89.64438544229755, 44.94256939980996],
               [-89.64436934904346, 44.94275545332197]]],
             [[[-89.8319916063289, 44.934341639048846],
               [-89.8320640259723, 44.93393339981955],
               [-89.83198892411988, 44.934144165551466]]],
             [[[-89.83503922008794, 44.93453519735077],
               [-89.83478709244054, 44.93454658999342],
               [-89.8349963047437, 44.934573172817494]]],
             [[[-89.83397958746309, 44.936975742843046],
               [-89.83450530043001, 44.93621246307654],
               [-89.83418879976625, 44.936596002933875]]],
             [[[-89.85138578286524, 44.93379249535123],
               [-89.85125837793703, 44.93379154595197],
               [-89.85126106014604, 44.93382192672077],
               [-89.85138578286524, 44.93382192672077]]],
             [[[-89.8402737106178, 44.92876488013484],
               [-89.84024487687088, 44.92864999265285],
               [-89.84018586827256, 44.928757284275385]]]]),
        {
          "class_2013": 1,
          "system:index": "0"
        }),
    tree = /* color: #32c133 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-89.64060806505883, 44.94303173498975],
               [-89.64065902703011, 44.94302034403056],
               [-89.64067377917969, 44.942974780171134],
               [-89.64062818162644, 44.9429358610126],
               [-89.6401172208091, 44.942955795219056],
               [-89.6401172208091, 44.94297098318122],
               [-89.64059063070023, 44.94295674446679]]],
             [[[-89.64274609835446, 44.94303239895553],
               [-89.64277694375814, 44.94305233312848],
               [-89.64279437811673, 44.94305138388229],
               [-89.64285472781957, 44.943012464775684],
               [-89.64286679776014, 44.942969748652686],
               [-89.6427876725942, 44.94295076369893],
               [-89.64288691432775, 44.942933677235175],
               [-89.64291910083593, 44.94290519978429],
               [-89.642932511881, 44.942871026824605],
               [-89.64291775973142, 44.94284539709147],
               [-89.64286545665563, 44.94284539709147],
               [-89.64286411555112, 44.94280173159384],
               [-89.64281181247533, 44.94277894958193],
               [-89.64274207504094, 44.94277989883259],
               [-89.64266965539754, 44.94290519978429],
               [-89.64272061736882, 44.94294696670743],
               [-89.64273805172742, 44.942997276824485]]],
             [[[-89.63565387876565, 44.922865726607014],
               [-89.63559621127183, 44.92289136525814],
               [-89.6355184272104, 44.9229103568442],
               [-89.63549562843377, 44.922938844211494],
               [-89.63550635726983, 44.92297302903361],
               [-89.63553452046449, 44.92301386087782],
               [-89.63565253766114, 44.92301291130039],
               [-89.63566728981073, 44.92303570115468],
               [-89.63572093399102, 44.923046146501555],
               [-89.6357879892164, 44.92303000369196]]],
             [[[-89.63664581082817, 44.92718722757263],
               [-89.63661228321548, 44.92717156068104],
               [-89.63659082554337, 44.9271696616636],
               [-89.63658680222984, 44.9271354793387],
               [-89.63656534455772, 44.92713595409335],
               [-89.63656936787125, 44.927120761942554],
               [-89.63659216664787, 44.927113165865656],
               [-89.63658948443886, 44.927099397973706],
               [-89.63657473228928, 44.92709844846381],
               [-89.63657070897575, 44.92708135728272],
               [-89.63653651081081, 44.927080882527605],
               [-89.63651907645222, 44.92707993301738],
               [-89.63651974700447, 44.927054296235596],
               [-89.6364976187801, 44.927054296235596],
               [-89.63649359546658, 44.92703625553043],
               [-89.63647079668995, 44.92703578077494],
               [-89.63645805619713, 44.92703150797549],
               [-89.63643190465923, 44.92703910406319],
               [-89.63641581140514, 44.927049548682135],
               [-89.63640240036007, 44.927061417565014],
               [-89.63636887274738, 44.927061892320275],
               [-89.63632260464188, 44.92705524574623],
               [-89.63628572426792, 44.92706758938312],
               [-89.63644531570431, 44.927149721976555]]],
             [[[-89.84010875476338, 44.92916793398794],
               [-89.84015435231663, 44.92916698451224],
               [-89.84020531428791, 44.929142298138046],
               [-89.8402200664375, 44.929110965417095],
               [-89.84021604312397, 44.929072986338475],
               [-89.8401677633617, 44.92905969365503],
               [-89.84017715109326, 44.929037855668376],
               [-89.84010473144986, 44.92900937132551],
               [-89.84004438174702, 44.9290236134987],
               [-89.83999073756672, 44.929054946267314],
               [-89.83999341977574, 44.92909482431174],
               [-89.8400229240749, 44.92912046018284]]],
             [[[-89.84036624682881, 44.92939770665021],
               [-89.84042391432263, 44.92939106034644],
               [-89.84045341862179, 44.92935592987089],
               [-89.8404373253677, 44.92932744568575],
               [-89.84034881247021, 44.92932839515882],
               [-89.84032199038006, 44.929349283562274],
               [-89.8403099204395, 44.92936922248579],
               [-89.84032064927555, 44.92938821193031]]],
             [[[-89.84007723880745, 44.92870601219758],
               [-89.84010540200211, 44.92869556787983],
               [-89.84013691795803, 44.92865379058981],
               [-89.84013960016705, 44.9286020436771],
               [-89.84013356519677, 44.92857213488978],
               [-89.84011680139042, 44.928555518890114],
               [-89.84005376947857, 44.92856311477626],
               [-89.84001957131363, 44.92857071066143],
               [-89.83998738480545, 44.92858257922999],
               [-89.8399766559694, 44.92861201326944],
               [-89.8399592216108, 44.92866328543113],
               [-89.83996726823784, 44.92868654778569],
               [-89.83998939646222, 44.92871028487248]]],
             [[[-89.84132245434262, 44.92871313332224],
               [-89.84132647765614, 44.928665659141195],
               [-89.84134994698502, 44.92866328543113],
               [-89.8413734163139, 44.92869319417098],
               [-89.84141297889687, 44.928685123560165],
               [-89.84141230834462, 44.928624356571795],
               [-89.8414082850311, 44.92861106378451],
               [-89.8413734163139, 44.92861153852697],
               [-89.84135799361206, 44.92858922562733],
               [-89.84133184207417, 44.92859777099417],
               [-89.8413184310291, 44.92859159934045],
               [-89.84129630280472, 44.928592548825684],
               [-89.84124936414696, 44.928620558632865],
               [-89.84124936414696, 44.928665659141195],
               [-89.84126813961007, 44.92868654778569],
               [-89.84129563225247, 44.92870743642259]]],
             [[[-89.84096974385716, 44.92867705294824],
               [-89.84098583711125, 44.92868844675301],
               [-89.84099790705181, 44.9287093353892],
               [-89.84100595367886, 44.9287325977251],
               [-89.84103009356, 44.92873687039802],
               [-89.84105490399338, 44.92871598177185],
               [-89.84108440829255, 44.92870553745591],
               [-89.8410763616655, 44.92862388182945],
               [-89.84102338803746, 44.92861676069372],
               [-89.84098315490223, 44.92864144729377],
               [-89.84094828618504, 44.92864999265285],
               [-89.8409502978418, 44.928675153980556]]],
             [[[-90.30575645797448, 44.756469578108906],
               [-90.3058228426476, 44.75646624496714],
               [-90.30585972302156, 44.7564629118252],
               [-90.30588319235044, 44.75644672227578],
               [-90.305895262291, 44.75641767630813],
               [-90.30589660339551, 44.75638434485183],
               [-90.30585637026029, 44.75636386980487],
               [-90.30584430031972, 44.75633958543744],
               [-90.30581077270703, 44.75633672845236],
               [-90.30575444631772, 44.75635006104819],
               [-90.30572695367532, 44.7563695837722],
               [-90.30572158925729, 44.756403867564295],
               [-90.30572561257081, 44.75643910366273],
               [-90.30572829477983, 44.7564576740303]]],
             [[[-90.3058215015431, 44.7562938736593],
               [-90.30586106412606, 44.75626768460344],
               [-90.30588788621621, 44.75623959087579],
               [-90.30589593284326, 44.75622197276844],
               [-90.30586374633508, 44.756205783151515],
               [-90.30583759479718, 44.756185784206714],
               [-90.30582686596112, 44.75621054480403],
               [-90.30580339663224, 44.756214830290936],
               [-90.30577188067632, 44.75619721217601],
               [-90.30576986901956, 44.75622102043815],
               [-90.3057417058249, 44.75622197276844],
               [-90.30573969416814, 44.75624292403064],
               [-90.30574036472039, 44.75626958926246],
               [-90.30576852791505, 44.75628292187374],
               [-90.30579736166196, 44.75628625502609]]],
             [[[-90.3061996930142, 44.756489576955495],
               [-90.30623187952237, 44.75645862635669],
               [-90.30623657338815, 44.75642577108747],
               [-90.30620841019349, 44.756408629200465],
               [-90.30617152981954, 44.75642434259708],
               [-90.30614671938615, 44.75643386586566],
               [-90.3061547660132, 44.756463864151485]]],
             [[[-90.30669609352243, 44.75646648423536],
               [-90.30672895058287, 44.75645648480894],
               [-90.30673632665766, 44.756430771990175],
               [-90.30672023340357, 44.756409820796094],
               [-90.30665384873045, 44.75641077312327],
               [-90.30665586038721, 44.756430295826775],
               [-90.30666457756651, 44.75645219933995]]],
             [[[-90.30696163221491, 44.756419820230605],
               [-90.30698845430506, 44.7564093446325],
               [-90.30700454755915, 44.75639029808567],
               [-90.30698711320055, 44.75636696605725],
               [-90.30697169049871, 44.756352204973155],
               [-90.30693950399053, 44.75635030031687],
               [-90.30690999969137, 44.756356490449576],
               [-90.30689927085531, 44.756394107395536],
               [-90.30692341073645, 44.75641458243178]]],
             [[[-90.3058169995178, 44.755914608542],
               [-90.30588003142965, 44.75592222722422],
               [-90.30585991486204, 44.75588794314638],
               [-90.30581297620428, 44.7559069898588]]],
             [[[-90.30581968172682, 44.75562462170383],
               [-90.30579554184568, 44.755601289366226],
               [-90.30573854490412, 44.755612241280964],
               [-90.30573854490412, 44.75563890680384],
               [-90.30576939030779, 44.755654620409736],
               [-90.30580895289076, 44.7556517633908]]],
             [[[-90.30562455102098, 44.75567652421692],
               [-90.3056547258724, 44.75565795359832],
               [-90.30565070255888, 44.755623193193614],
               [-90.30561650439394, 44.7556031940472],
               [-90.30559169396055, 44.755598908514926],
               [-90.30550854548109, 44.75564843020186],
               [-90.30553134425772, 44.75568319059138],
               [-90.30556956573618, 44.755687952286934]]],
             [[[-90.30543076141966, 44.75553176846776],
               [-90.3054736767639, 44.75553272080942],
               [-90.30552597983969, 44.75552748293019],
               [-90.3055648718704, 44.75549605564494],
               [-90.30556822463167, 44.75544367679818],
               [-90.3055387203325, 44.75540605923352],
               [-90.30549312277925, 44.75539225024794],
               [-90.30544014915121, 44.75541177329555],
               [-90.30540528043402, 44.7554365342245],
               [-90.30540662153852, 44.75545843811436],
               [-90.30540393932951, 44.75549891267156]]]]),
        {
          "class_2013": 3,
          "system:index": "0"
        }),
    water = /* color: #4740ff */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-89.8305512600879, 44.93464924064399],
               [-89.83035545882981, 44.93459227750993],
               [-89.83014088210862, 44.934438476765756],
               [-89.8299021655063, 44.934440375542884],
               [-89.82978414830964, 44.93431885367994],
               [-89.82988875446122, 44.93422391454561],
               [-89.8298136526088, 44.9341859388479],
               [-89.82974659738343, 44.93433404392689],
               [-89.82979219493669, 44.934387209759485],
               [-89.8298672967891, 44.93445556575766],
               [-89.82996385631364, 44.93447265474451],
               [-89.8301355176906, 44.934470755968434],
               [-89.83022939500611, 44.9345372130933],
               [-89.83035545882981, 44.93462645539714],
               [-89.8305512600879, 44.93469481111054]]],
             [[[-89.83322068237584, 44.93532508188752],
               [-89.83310802959721, 44.935271916923185],
               [-89.833070478671, 44.935199764392884],
               [-89.83288808845799, 44.93529470191394],
               [-89.8330329277448, 44.9352491319234]]],
             [[[-89.63585504444177, 44.92313445708548],
               [-89.63474997432763, 44.922815398851135],
               [-89.63529714496667, 44.923058490999914]]]]),
        {
          "class_2013": 4,
          "system:index": "0"
        });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var pts = ee.FeatureCollection('users/erker/UTC/marathon_shapefiles/marathon_combined_sub_50k');
var pts = pts.remap([1,2,3,4,5], [0,1,2,3,4], 'class_2013');


var trainingData = pts.merge(grass).merge(tree).merge(soil).merge(impervious).merge(water);


var testpts = ee.FeatureCollection('users/erker/UTC/marathon_shapefiles/marathon_accuracy_randompoints_20200522').filter(ee.Filter.neq('class_2013', '')).remap(['G','I','S','T','W'], [0,1,2,3,4], 'class_2013');

var naip = ee.ImageCollection('USDA/NAIP/DOQQ').filterBounds(testpts);  // testpts has greater extent than pts
var naip13c = naip.filterDate('2013-01-01', '2013-12-31');
var naip15c = naip.filterDate('2015-01-01', '2015-12-31');


var naip13 = naip13c.median().byte();
var naip15 = naip15c.median().byte();


var ndvi13 = naip13.normalizedDifference(['N', 'R']);
var gauss53 = ee.Kernel.gaussian({radius: 5, sigma: 3, units: 'pixels', normalize:true});
var naip13Gauss53 = naip13.convolve(gauss53);
var naip15Gauss53 = naip15.convolve(gauss53);
var gauss104 = ee.Kernel.gaussian({radius: 10, sigma: 4, units: 'pixels', normalize:true});
var naip13Gauss104 = naip13.convolve(gauss104);
var naip15Gauss104 = naip15.convolve(gauss104);
var heightGauss104 = height.convolve(gauss104);
var win10 = ee.Kernel.square({radius: 10});
var entro10 = naip13.select('N').entropy(win10);
var win5 = ee.Kernel.square({radius: 5});
var entro5 = naip13.select('N').entropy(win5);
var nir13glcm3 = naip13.select(['N']).glcmTexture({size: 3, average: false});
var contrast3 = nir13glcm3.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir13glcm7 = naip13.select(['N']).glcmTexture({size: 7, average: false});
var contrast7 = nir13glcm7.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir13glcm14 = naip13.select(['N']).glcmTexture({size: 14, average: false});
var contrast14 = nir13glcm14.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');


// Create a list of weights for a 9x9 kernel.
var bottomList = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1];
var list =       [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
var lists = [list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, list, bottomList];
var shift = ee.Kernel.fixed(25, 25, lists, -12, -12, false);
var heightshift = height.convolve(shift);

var image = ee.Image.cat([naip13, naip15, ndvi13, naip13Gauss53, naip13Gauss104, naip15Gauss104, entro10, entro5, contrast3, contrast7, contrast14, wl, wb, height, heightGauss104, heightshift]);


var classProperty = 'class_2013';


var training = image.sampleRegions({
  collection: trainingData,
  properties: [classProperty],
  scale: 1
});
print(training.size());

training = training.randomColumn();
var split = 0.75;
var training = training.filter(ee.Filter.lt('random', split));
print(training.size());


var trainedClassifier = ee.Classifier.smileRandomForest(100).train({
  features: training,
  classProperty: classProperty,
  inputProperties: image.bandNames()
});

// print(trainedClassifier);

var testing = image.sampleRegions({collection: testpts, properties: [classProperty], scale: 1});
var testClassified = testing.classify(trainedClassifier);
var testAccuracy = testClassified.errorMatrix(classProperty, 'classification');
print('Validation error matrix: ', testAccuracy);
print('Validation overall accuracy: ', testAccuracy.accuracy());


var classified = image.classify(trainedClassifier);


Map.addLayer(height);
Map.addLayer(heightshift);
Map.addLayer(naip13);
Map.addLayer(naip15);
Map.addLayer(classified, {min: 0, max: 4, palette: ['yellow', 'red', 'brown','green','blue']});



// Export.image.toDrive({
//   image: classified,
//   description: 'marathon-2013',
//   scale: 1,
// });


Export.image.toDrive({
  image: classified,
  description: 'marathon-2013-fullcounty',
  scale: 1,
  maxPixels: 12000000000,
  crs: 'EPSG:3070'
});


