/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var grass = /* color: #fcff29 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-87.89614692241388, 43.025922720733824],
               [-87.89620123714643, 43.02596046642376],
               [-87.89627566844659, 43.0259393876647],
               [-87.89641916662889, 43.02590213216589],
               [-87.8961509457274, 43.02591438726668]]],
             [[[-87.90586916116983, 42.846396306112695],
               [-87.90554193167002, 42.84638254032774],
               [-87.905539249461, 42.84642973729195],
               [-87.90588525442392, 42.84643956998826]]],
             [[[-87.89589422125518, 42.85286919897576],
               [-87.89582448382079, 42.85290754248489],
               [-87.89591433782279, 42.852985212597105]]],
             [[[-87.89624258648594, 42.8530982650002],
               [-87.89642363559445, 42.85303829199396],
               [-87.89636328589161, 42.85301518762356]]],
             [[[-87.98654681636032, 42.88845715413648],
               [-87.98655754519638, 42.88798943453447],
               [-87.98651731206115, 42.8882625989345]]],
             [[[-87.98867377993183, 42.88825880482644],
               [-87.98837605473118, 42.88824504837396],
               [-87.988523576227, 42.888282387309296]]],
             [[[-87.99825155054565, 42.88723861238657],
               [-87.99819388305183, 42.88725826478126],
               [-87.9982247284555, 42.88731623930916],
               [-87.99830251251693, 42.88731230883441]]],
             [[[-87.9982609382772, 42.887176707302345],
               [-87.99819388305183, 42.88717179419775],
               [-87.99819388305183, 42.88724057762632]]],
             [[[-87.99774193083282, 42.887225838326636],
               [-87.99764403020377, 42.88718162040653],
               [-87.99764268909927, 42.887254334302824]]],
             [[[-87.99718537246223, 42.8875618934838],
               [-87.99729802524085, 42.887529467188784],
               [-87.99719341908927, 42.88740467492474],
               [-87.99718269025321, 42.88756877178658]]],
             [[[-87.99540949301992, 42.88781137742597],
               [-87.99527270036016, 42.88774062941012],
               [-87.99525928931509, 42.887914551470296]]]]),
        {
          "class_2010": 0,
          "system:index": "0"
        }),
    impervious = /* color: #be1414 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-87.89641112000184, 43.02589870073722],
               [-87.89640843779283, 43.025871249301034],
               [-87.89613418192106, 43.02588301420375],
               [-87.89614424020486, 43.025912916654704]]],
             [[[-87.89702556946601, 42.85548025262303],
               [-87.89697997191276, 42.85532000293599],
               [-87.89697594859923, 42.85554317263185]]]]),
        {
          "class_2010": 1,
          "system:index": "0"
        }),
    soil = /* color: #d2a525 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-87.90174382092083, 43.027271365549005],
               [-87.90173175098026, 43.02709391537346],
               [-87.90155338408077, 43.02708607225996],
               [-87.9015775239619, 43.02727626748026]]],
             [[[-87.93418085650494, 42.970964073943],
               [-87.934101731339, 42.97094739209354],
               [-87.93409368471195, 42.97087477693139],
               [-87.93392336443951, 42.97087870207748],
               [-87.93394482211163, 42.97096505522812],
               [-87.93400383070995, 42.97102491359095],
               [-87.93407222703983, 42.971070052645715]]],
             [[[-87.93426599879092, 42.97087364952897],
               [-87.93429885585135, 42.97087659338864],
               [-87.93431964297122, 42.9708520612206],
               [-87.9343156196577, 42.97082507582448],
               [-87.93425996382064, 42.97082851033009],
               [-87.93424588222331, 42.97085107993368]]],
             [[[-87.93196852123236, 42.97137366723718],
               [-87.93196315681433, 42.97129712745914],
               [-87.93185452734923, 42.971278483139834],
               [-87.93185050403571, 42.971339322476794]]],
             [[[-87.9164677868252, 42.84845743446747],
               [-87.91642889479448, 42.848394507239554],
               [-87.91632831195642, 42.848394507239554]]],
             [[[-87.91392530427325, 42.84811542089195],
               [-87.91394407973635, 42.84803086194643],
               [-87.91387568340647, 42.84808395711179]]],
             [[[-87.89670709024702, 42.85338580428369],
               [-87.8966856325749, 42.85338777060162],
               [-87.89668295036589, 42.85360013256983]]],
             [[[-87.8957872331366, 42.853972645929495],
               [-87.8958006441819, 42.85383697112801],
               [-87.8957684576732, 42.853831072216884],
               [-87.89575906994148, 42.85397067963014]]]]),
        {
          "class_2010": 2,
          "system:index": "0"
        }),
    tree = /* color: #15c232 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-87.89903440560481, 43.02690538052191],
               [-87.89903440560481, 43.026846556965424],
               [-87.89897271479747, 43.026833811854104],
               [-87.89893516387126, 43.02685047853761],
               [-87.89894052828929, 43.02690145895323],
               [-87.89898478473803, 43.026918125618394]]],
             [[[-87.89832630242488, 43.026673027145364],
               [-87.89837055887362, 43.026673027145364],
               [-87.89838933433673, 43.02670538019986],
               [-87.89844834293505, 43.02669557624575],
               [-87.89847784723422, 43.02663871328105],
               [-87.89842688526294, 43.02658086986637],
               [-87.89832362021586, 43.02658086986637],
               [-87.89830350364825, 43.026613222969445],
               [-87.89827265824458, 43.02664851724424]]],
             [[[-87.88066999835209, 42.84348832183311],
               [-87.88134591502384, 42.8434863552],
               [-87.88049833697514, 42.84334869072807],
               [-87.88091139716343, 42.84318939288483]]],
             [[[-87.90343384303314, 42.843086515022684],
               [-87.90340702094299, 42.842952782960126],
               [-87.90308247365219, 42.84305898197464]]],
             [[[-87.92858081921345, 42.84603831392974],
               [-87.92880344256169, 42.846036347377826],
               [-87.92872029408223, 42.845918354148374],
               [-87.92840379341847, 42.84583379219525],
               [-87.9281945811153, 42.84581412660818],
               [-87.92813557251698, 42.84602258151268],
               [-87.92837160691029, 42.846018648407785]]],
             [[[-87.89603087321206, 42.85454275202661],
               [-87.89606976524277, 42.854547667729236],
               [-87.89610195175095, 42.8545289880572],
               [-87.89608183518334, 42.85449654440282],
               [-87.89604428425713, 42.85448769613051],
               [-87.89601746216698, 42.854503426391545]]],
             [[[-87.89536166206284, 42.85426353947532],
               [-87.89541932955666, 42.85427926979346],
               [-87.89545688048287, 42.85424879229844],
               [-87.89545956269188, 42.85419963501672],
               [-87.89538848415299, 42.85418685411704],
               [-87.89533886328621, 42.85421241591373]]],
             [[[-87.8953881775747, 42.85467298089549],
               [-87.89545992666585, 42.85465331812255],
               [-87.89547467881543, 42.85462136610317],
               [-87.89544316285951, 42.85458793935749],
               [-87.89537476652963, 42.85458843092741],
               [-87.89532313400609, 42.85464102888627],
               [-87.89535129720075, 42.85466216637114]]],
             [[[-87.8955561804857, 42.85531359665887],
               [-87.89563128233812, 42.85526591491832],
               [-87.89562658847234, 42.855184315153146],
               [-87.8955662387695, 42.855150397146765],
               [-87.89549918354413, 42.85513712487833],
               [-87.89539927125833, 42.855173500718365],
               [-87.89534830928704, 42.85521872470582],
               [-87.89538854242227, 42.85527869559465],
               [-87.89543682218454, 42.855325885761296]]],
             [[[-87.89693035104598, 42.855491067004095],
               [-87.89693571546401, 42.85541634942344],
               [-87.89692096331443, 42.85536817619849],
               [-87.89685256698455, 42.85535834492349],
               [-87.8967546663555, 42.85537112558068],
               [-87.89671040990676, 42.85544486008988],
               [-87.89677880623664, 42.85548418512545],
               [-87.89685390808906, 42.85550876325998]]]]),
        {
          "class_2010": 3,
          "system:index": "0"
        }),
    water = /* color: #3049c2 */ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-87.89603875921945, 43.02577634122819],
               [-87.89605082916002, 43.02587536257554],
               [-87.89640622185449, 43.02585967603612]]],
             [[[-87.88370289724321, 42.84228177674939],
               [-87.88406767766924, 42.84215590964726],
               [-87.88393893163652, 42.841778306802375]]],
             [[[-87.90349274329012, 42.84286415627245],
               [-87.90369659124946, 42.842803189986434],
               [-87.90362953599777, 42.84274025697031],
               [-87.90355979852956, 42.84279925666555]]],
             [[[-87.90554461387903, 42.84632944369994],
               [-87.90553656725199, 42.846370741081074],
               [-87.90586916116983, 42.84638254032774]]],
             [[[-87.90540676130398, 42.846351711244225],
               [-87.90540005578144, 42.8463723599308],
               [-87.9054832042609, 42.84638317590671]]],
             [[[-87.8962995834275, 42.85299699907056],
               [-87.8962881840392, 42.8529945411576],
               [-87.89620637666424, 42.85306041319158]]],
             [[[-87.89634652208527, 42.85298962533134],
               [-87.89639882516106, 42.852940958630384],
               [-87.89637736748894, 42.852933093301374]]],
             [[[-87.9931023555201, 42.88855627017137],
               [-87.99317209295448, 42.88851500100369],
               [-87.99310503772911, 42.888479627409424],
               [-87.99302457145866, 42.888499279408755]]]]),
        {
          "class_2010": 4,
          "system:index": "0"
        }),
    errors = ee.FeatureCollection("users/erker/milwaukee/milwaukee_shapefiles/Tree_Map_Errors_MKE_fromDan");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var milwaukeeExport = ee.Geometry.Polygon(
        [[[-88.35575750089527, 43.35209206347098],
          [-88.35575750089527, 42.80743795582355],
          [-87.76249578214527, 42.80743795582355],
          [-87.76249578214527, 43.35209206347098]]], null, false),
    wb = ee.Image("users/erker/milwaukee/milwaukee_water/mke_water_bodies_26916_input"),
    wl = ee.Image("users/erker/milwaukee/milwaukee_water/mke_water_lines_26916_input"),
    height = ee.Image("users/erker/milwaukee/milwaukee_height/mke_2010height");

var pts = ee.FeatureCollection('users/erker/milwaukee/milwaukee_shapefiles/milwaukee_accuracy_training');

var classProperty = 'class_2010';

var pts = pts.remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);

var trainingData = pts.merge(grass).merge(tree).merge(soil).merge(impervious).merge(water);

var testpts = ee.FeatureCollection('users/erker/milwaukee/milwaukee_shapefiles/milwaukee_accuracy_testing').filter(ee.Filter.neq(classProperty, '')).remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);
// var testpts = testpts.randomColumn();
// testpts =  testpts.filter(ee.Filter.lt('random', 0.01));
// print(testpts.size());



var buf3000 = function(feature) {return feature.buffer(3000)};
var urbanregion = testpts.map(buf3000);
var naip = ee.ImageCollection('USDA/NAIP/DOQQ').filterBounds(urbanregion); 
var naip05c = naip.filterDate('2005-01-01', '2005-12-31');
var naip08c = naip.filterDate('2008-01-01', '2008-12-31');
var naip10c = naip.filterDate('2010-01-01', '2010-12-31');




var naip05 = naip05c.median().byte();
var naip08 = naip08c.median().byte();
var naip10 = naip10c.median().byte();



var ndvi10 = naip10.normalizedDifference(['N', 'R']);
var gauss53 = ee.Kernel.gaussian({radius: 5, sigma: 3, units: 'pixels', normalize:true});
var naip10Gauss53 = naip10.convolve(gauss53);
var naip08Gauss53 = naip08.convolve(gauss53);
var gauss104 = ee.Kernel.gaussian({radius: 10, sigma: 4, units: 'pixels', normalize:true});
var naip10Gauss104 = naip10.convolve(gauss104);
var naip08Gauss104 = naip08.convolve(gauss104);
var win10 = ee.Kernel.square({radius: 10});
var entro10 = naip10.select('N').entropy(win10);
var win5 = ee.Kernel.square({radius: 5});
var entro5 = naip10.select('N').entropy(win5);
var nir10glcm3 = naip10.select(['N']).glcmTexture({size: 3, average: false});
var contrast3 = nir10glcm3.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir10glcm7 = naip10.select(['N']).glcmTexture({size: 7, average: false});
var contrast7 = nir10glcm7.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir10glcm14 = naip10.select(['N']).glcmTexture({size: 14, average: false});
var contrast14 = nir10glcm14.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');

var image = ee.Image.cat([naip05, naip08, naip10, ndvi10, naip10Gauss53, naip10Gauss104, entro5, contrast3, wl, wb, height]);

var training = image.sampleRegions({
  collection: trainingData,
  properties: [classProperty],
  scale: 1
});
print(training.size());

// training = training.randomColumn();

// var split = 0.1;
// var training = training.filter(ee.Filter.lt('random', split));
// print(training.size());


var trainedClassifier = ee.Classifier.smileRandomForest(100).train({
  features: training,
  classProperty: classProperty,
  inputProperties: image.bandNames()
});

// print(trainedClassifier);

var testing = image.sampleRegions({collection: testpts, properties: [classProperty], scale: 1});
var testClassified = testing.classify(trainedClassifier);
var testAccuracy = testClassified.errorMatrix(classProperty, 'classification');
print('testing error matrix: ', testAccuracy);
print('testing overall accuracy: ', testAccuracy.accuracy());


var classified = image.classify(trainedClassifier);



Map.addLayer(naip05);
Map.addLayer(naip08);
Map.addLayer(height);
Map.addLayer(naip10);
Map.addLayer(classified, {min: 0, max: 4, palette: ['yellow', 'red', 'brown','green','blue']});

Map.addLayer(errors);

// Export.image.toDrive({
//   image: classified,
//   description: 'marathon-2010-5',
//   scale: 1,
// });


// Export.image.toDrive({
//   image: classified,
//   description: 'milwaukee-2010-fullcounty',
//   scale: 1,
//   maxPixels: 12000000000,
//   crs: 'EPSG:3070'
// });


// Export.image.toAsset({
//   image: classified,
//   description: 'milwaukeeClassified2010',
//   assetId: 'milwaukeeClassified2010',
//   scale: 1,
//   region: marathonExport,
//   pyramidingPolicy: {
//     'classification': 'mode'
//   }
// });