/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var marathonExport = 
    /* color: #d6d6d6 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-89.51381422286656, 45.17235954378038],
          [-89.80769850021031, 45.164613914682704],
          [-89.81456495528843, 45.06382488709884],
          [-89.94228101974156, 45.05994483116828],
          [-89.94090772872593, 45.13846464027344],
          [-90.17848707442906, 45.1239320814499],
          [-90.18260694747593, 45.05703461641353],
          [-90.39684034591343, 45.05509439095473],
          [-90.42155958419468, 44.76233996072894],
          [-90.37486768966343, 44.75161305264964],
          [-90.29933668380406, 44.680374932466826],
          [-90.30208326583531, 44.62273483464385],
          [-90.27461744552281, 44.59536016796341],
          [-90.02467848067906, 44.58558037460749],
          [-90.00545240646031, 44.74771186508599],
          [-89.91756178146031, 44.82178940158957],
          [-89.79671217208531, 44.82763357963028],
          [-89.79671217208531, 44.69111505555379],
          [-89.13203932052281, 44.6950200611524],
          [-89.13478590255406, 44.979374249676255],
          [-89.50557447677281, 44.996857015658165]]]),
    grass = /* color: #d6d536 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.57977777804271, 44.92915747600266],
             [-89.57987433756725, 44.92917456656601],
             [-89.57988238419429, 44.9291062042821],
             [-89.57996285046474, 44.92913278962439],
             [-89.57981801117793, 44.929218242427034],
             [-89.58000844801799, 44.9291156990486],
             [-89.58010232533351, 44.9291498801951],
             [-89.58008623207942, 44.92911000218888],
             [-89.5800272234811, 44.929102406375065],
             [-89.57979118908779, 44.92911759800173],
             [-89.57971340502635, 44.92917646551719],
             [-89.57978850687877, 44.92907012415501],
             [-89.57972949828044, 44.92914038543421],
             [-89.57994139279262, 44.92908151788179],
             [-89.58028203333751, 44.929218242427034],
             [-89.58040809716121, 44.92917836446829],
             [-89.58036786402599, 44.92925432246107],
             [-89.58030885542766, 44.92917266761478],
             [-89.58037859286205, 44.929096709514006],
             [-89.58032763089076, 44.92914228438652],
             [-89.57953637923137, 44.92946510536494],
             [-89.57962757433788, 44.929453711714224],
             [-89.57960879887477, 44.9293549666468],
             [-89.57954710806743, 44.9293549666468],
             [-89.57866734351055, 44.929468903248],
             [-89.57870489443675, 44.92948409477773],
             [-89.57871025885478, 44.92940433920172],
             [-89.57864856804744, 44.9293511687562],
             [-89.57868880118266, 44.929256221409595],
             [-89.57863515700237, 44.92918406132124],
             [-89.57864856804744, 44.92903784191683],
             [-89.60874138181217, 44.95385154446571],
             [-89.60876015727527, 44.9540546445702],
             [-89.60889963214404, 44.954045153927105],
             [-89.60884867017276, 44.95396163620033],
             [-89.6088567167998, 44.95385154446571],
             [-89.60887012784488, 44.95365983249267],
             [-89.60893450086124, 44.95347001802702],
             [-89.60887549226291, 44.953348536439535],
             [-89.60873869960315, 44.95348710135463],
             [-89.60873333518512, 44.953824970567084],
             [-89.60876283948429, 44.953667425058235],
             [-89.52107812902337, 44.8963916305422],
             [-89.52108885785943, 44.896330829398686],
             [-89.52110763332253, 44.8964714319455],
             [-89.52107008239632, 44.89630992899076],
             [-89.5211559130848, 44.896353629835055],
             [-89.52115054866677, 44.896448631555884],
             [-89.52417409173093, 44.895730177151975],
             [-89.52423041812024, 44.895716876754314],
             [-89.52441280833325, 44.89564467454201],
             [-89.52437793961606, 44.89567317542613],
             [-89.52366178980908, 44.895570572177256],
             [-89.52368861189923, 44.895542071242275],
             [-89.52399438372693, 44.895500269845456],
             [-89.52365374318204, 44.89568457577583],
             [-89.52364301434598, 44.89564277448257],
             [-89.52361619225583, 44.8956807756595],
             [-89.52371006957135, 44.89521525951178],
             [-89.52371006957135, 44.89526086126008],
             [-89.52367788306317, 44.89536156499285],
             [-89.52303147069058, 44.89560477328055],
             [-89.52304219952664, 44.895561071867164],
             [-89.52302342406354, 44.89549836978125],
             [-89.52296441546521, 44.89565987501528],
             [-89.52264523259244, 44.89559907309808],
             [-89.52266400805554, 44.895547771430415],
             [-89.52265864363751, 44.89578717882131],
             [-89.5226371859654, 44.89572637703868],
             [-89.52265864363751, 44.89589738188845],
             [-89.52464079609952, 44.89589548183735],
             [-89.52502703419766, 44.895834680169244],
             [-89.5249975298985, 44.895870781167446],
             [-89.52578341713986, 44.89572447698193],
             [-89.52583169690213, 44.895711176582964],
             [-89.52585851899228, 44.895752977826476],
             [-89.5258451079472, 44.8957035763536],
             [-89.52579951039395, 44.895709276525736],
             [-89.52565467110715, 44.89535586478626],
             [-89.52570295086942, 44.89521525951178],
             [-89.52568685761533, 44.895300762760186],
             [-89.52571367970548, 44.895374865472654],
             [-89.5256814931973, 44.89536916526741],
             [-89.47316632921786, 44.90358559626458],
             [-89.47293029482455, 44.90360459423154],
             [-89.4644998901652, 44.907636374746616],
             [-89.46447038586604, 44.90763827440971],
             [-89.46443819935786, 44.907643973398685],
             [-89.46441137726771, 44.907643973398685],
             [-89.46446770365702, 44.90744450844891],
             [-89.4644274705218, 44.907461605471724],
             [-89.46438723738657, 44.90747490315264],
             [-89.464465021448, 44.90776745135405],
             [-89.46450793679224, 44.90774845476279],
             [-89.46443283493983, 44.90772755850518],
             [-89.46448379691111, 44.90772755850518],
             [-89.46449720795619, 44.907864333871785],
             [-89.46579003270136, 44.90762497676661],
             [-89.46581685479151, 44.90759458214227],
             [-89.4657605284022, 44.90735332424134],
             [-89.4658141725825, 44.907315330778836],
             [-89.46575516398417, 44.90719375153004],
             [-89.43939714322163, 44.91074222330017],
             [-89.44278745541645, 44.910643446069464],
             [-90.23433415571164, 44.66335998536675],
             [-90.2341839520068, 44.663459186662564],
             [-90.22988168874691, 44.663642327070406],
             [-90.24383990446042, 44.664771680134294],
             [-90.14375786757056, 44.68427985116757],
             [-90.14186959242407, 44.68480618914546],
             [-90.142577695604, 44.684851957439285],
             [-90.14547448134009, 44.68447818198161]]),
        {
          "class_2010": 0,
          "system:index": "0"
        }),
    impervious = /* color: #ff1f1f */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.62933410961207, 44.93780538092992],
             [-89.6293394740301, 44.937345901959496],
             [-89.62932874519404, 44.93668895456577],
             [-89.62931265193996, 44.93653326072916],
             [-89.62931801635798, 44.9363016178983],
             [-89.62729026634273, 44.93709907289532],
             [-89.62729563076076, 44.9373534966831],
             [-89.62732781726893, 44.93783575957526],
             [-89.62732781726893, 44.93800284183724],
             [-89.62648023922023, 44.93772183957242],
             [-89.62438811618861, 44.937330712509265],
             [-89.62438811618861, 44.93725476519781],
             [-89.62457050640162, 44.93721299413371],
             [-89.64701369503956, 44.9649236760581],
             [-89.63913872937184, 44.965538549894845],
             [-89.64919164875965, 44.96206936058693],
             [-89.65531781414967, 44.964513756505525],
             [-89.65527489880543, 44.964688352228606],
             [-89.65383723477345, 44.964688352228606],
             [-89.65388015011769, 44.964453027433784],
             [-89.61824600852411, 44.954701855692576],
             [-89.6178490415899, 44.953616128188365],
             [-89.61504881537836, 44.95540794717189],
             [-89.52107008239632, 44.896473331977575],
             [-89.52108885785943, 44.896547433179016],
             [-89.52105935356026, 44.89657403358704],
             [-89.52113177320366, 44.89655503329687],
             [-89.52114786645775, 44.89668423514622],
             [-89.52109958669548, 44.896718435587175],
             [-89.5225835417851, 44.895768178271126],
             [-89.52258085957608, 44.89590308204136],
             [-89.52259695283017, 44.89599238436305],
             [-89.52257549515805, 44.89561617364378],
             [-89.52257281294904, 44.895473668940745],
             [-89.52260768166623, 44.89531026311328],
             [-89.52262377492032, 44.89554017117945],
             [-89.52261841050229, 44.89585368069744],
             [-89.52504166174134, 44.894400085466565],
             [-89.52579268026551, 44.89418727381298],
             [-89.52756293821534, 44.89444568786131],
             [-89.52621899582938, 44.89525296776644],
             [-89.52620826699332, 44.895353671513035],
             [-89.52628068663672, 44.895256767911036],
             [-89.52625654675559, 44.895302369626435],
             [-89.5262753222187, 44.89521876645391],
             [-89.51411516912121, 44.89717770884886],
             [-89.51322467572827, 44.89669130454997],
             [-89.51363237149853, 44.89644050072567],
             [-89.51170118100781, 44.897968107059214],
             [-89.51583178289074, 44.89576408495819],
             [-89.51665790326733, 44.895984490969816],
             [-89.51653988607067, 44.89577168517957],
             [-89.50897873885769, 44.89740000944366],
             [-89.50222146834525, 44.89665802997044],
             [-89.46949453320666, 44.905648528964505],
             [-89.46945698228045, 44.90563713059035],
             [-89.46943552460833, 44.90569412243853],
             [-89.46955085959597, 44.90561433383526],
             [-89.46947307553454, 44.90556304110324],
             [-89.46963669028445, 44.90558393814773],
             [-89.46986736025973, 44.90555924163979],
             [-89.4704198953168, 44.905593436801816],
             [-90.19210740795526, 44.64058106228358],
             [-90.1887278245965, 44.63472558610928],
             [-89.64712075348467, 44.947145502542455],
             [-89.64700810070605, 44.947141705828386],
             [-89.64752576704592, 44.947612496457026],
             [-89.6376874243793, 44.94929060583383],
             [-89.65326569433779, 44.94676203315397],
             [-89.63468335028261, 44.947077161650896],
             [-89.62942622061342, 44.945334441425395]]),
        {
          "class_2010": 1,
          "system:index": "0"
        }),
    soil = /* color: #c09b5f */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.53089706101454, 44.89587083987659],
             [-89.53101034900551, 44.895982171600025],
             [-89.53080516001587, 44.8958900191856],
             [-89.51378257520336, 44.897276509219324],
             [-90.24345366636227, 44.66195588728309],
             [-90.24964420476864, 44.66189483876891],
             [-90.24047104993771, 44.662795297834194],
             [-90.23976294675778, 44.66194825622232],
             [-90.21416600941383, 44.6443254377289],
             [-90.21673020123207, 44.64238652668211],
             [-90.10996203398291, 44.68454683479747],
             [-90.10824542021338, 44.68450106626262],
             [-90.11191468214575, 44.684562090967745]]),
        {
          "class_2010": 2,
          "system:index": "0"
        }),
    tree = /* color: #40c660 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.57959270562068, 44.92912519381357],
             [-89.57964634980098, 44.929104305328586],
             [-89.5796678074731, 44.929049235650005],
             [-89.57963562096492, 44.929024549225225],
             [-89.5796865829362, 44.92909101265239],
             [-89.57959807003871, 44.929113800095436],
             [-89.57957124794856, 44.9290777199731],
             [-89.5795766123666, 44.92901885235646],
             [-89.57951760376827, 44.929060629380935],
             [-89.60871880210321, 44.95374520176467],
             [-89.60868661559503, 44.95401853308566],
             [-89.60870807326715, 44.953433906174624],
             [-89.6086743265868, 44.95357821234938],
             [-89.60868505542285, 44.9538021929299],
             [-89.60866627995975, 44.95395404367371],
             [-89.60869578425891, 44.95414195841287],
             [-89.43726210484577, 44.911919938741384],
             [-89.43655400166584, 44.91196552724102],
             [-89.43734793553425, 44.91149444433418],
             [-89.43753032574726, 44.91138047208308],
             [-89.43603901753498, 44.91172998627026],
             [-89.43632869610859, 44.91150204247624],
             [-90.11020879721228, 44.68861246203078],
             [-90.11040191626135, 44.68861246203078],
             [-90.11108856176917, 44.68842940052317],
             [-90.11083106970374, 44.688330241964984],
             [-89.63523052092165, 44.94605203851399],
             [-89.63524124975771, 44.94536481608714],
             [-89.6352036988315, 44.946670911338444],
             [-89.63064930792422, 44.947585919669514],
             [-89.6305205618915, 44.947422661990714]]),
        {
          "class_2010": 3,
          "system:index": "0"
        }),
    water = /* color: #1b1dff */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-89.63514760235768, 44.96267667364435],
             [-89.63521197537403, 44.96301828441398],
             [-89.63184312085133, 44.96319288468848],
             [-89.51447994954724, 44.89757290931214],
             [-89.5079301716094, 44.89597302294341],
             [-89.45152072796894, 44.910696633830185],
             [-89.45166020283772, 44.90961767248497],
             [-90.12351255392615, 44.68570629228645],
             [-90.12403826689307, 44.68580545533655],
             [-89.62397597189516, 44.944795288504764],
             [-89.6276559626636, 44.944977537945874],
             [-89.62726972456545, 44.94474213230876],
             [-89.62801001425356, 44.945865995685715]]),
        {
          "class_2010": 4,
          "system:index": "0"
        });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var wl = ee.Image("users/erker/UTC/marathon_water/water_lines");
var wb = ee.Image("users/erker/UTC/marathon_water/water_bodies");

var classProperty = 'class_2010';

var pts = ee.FeatureCollection('users/erkere/marathonShapefiles/marathon_accuracy_training').remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);

var trainingData = pts.merge(grass).merge(tree).merge(soil).merge(impervious).merge(water);
print(trainingData.size());

var buf3000 = function(feature) {return feature.buffer(3000)};
var urbanregion = testpts.map(buf3000);
var naip = ee.ImageCollection('USDA/NAIP/DOQQ').filterBounds(urbanregion); 
var naip05c = naip.filterDate('2005-01-01', '2005-12-31');
var naip08c = naip.filterDate('2008-01-01', '2008-12-31');
var naip10c = naip.filterDate('2010-01-01', '2010-12-31');


var naip05 = naip05c.median().byte();
var naip08 = naip08c.median().byte();
var naip10 = naip10c.median().byte();



var ndvi10 = naip10.normalizedDifference(['N', 'R']);
var gauss53 = ee.Kernel.gaussian({radius: 5, sigma: 3, units: 'pixels', normalize:true});
var naip10Gauss53 = naip10.convolve(gauss53);
var naip08Gauss53 = naip08.convolve(gauss53);
var gauss104 = ee.Kernel.gaussian({radius: 10, sigma: 4, units: 'pixels', normalize:true});
var naip10Gauss104 = naip10.convolve(gauss104);
var naip08Gauss104 = naip08.convolve(gauss104);
var win10 = ee.Kernel.square({radius: 10});
var entro10 = naip10.select('N').entropy(win10);
var win5 = ee.Kernel.square({radius: 5});
var entro5 = naip10.select('N').entropy(win5);
var nir10glcm3 = naip10.select(['N']).glcmTexture({size: 3, average: false});
var contrast3 = nir10glcm3.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir10glcm7 = naip10.select(['N']).glcmTexture({size: 7, average: false});
var contrast7 = nir10glcm7.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir10glcm14 = naip10.select(['N']).glcmTexture({size: 14, average: false});
var contrast14 = nir10glcm14.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');

// var image = ee.Image.cat([naip05, naip08, naip10, ndvi10, naip10Gauss53, naip10Gauss104, naip08Gauss104, entro10, entro5, contrast3, contrast7, contrast14, wl, wb]);
var image = ee.Image.cat([naip05, naip08, naip10, naip10Gauss53, naip10Gauss104, entro5, contrast3, wl, wb]);
var image = ee.Image.cat([naip05, naip08, naip10, naip10Gauss53, entro10, entro5, contrast3, contrast7, wl, wb]);


var training = image.sampleRegions({
  collection: trainingData,
  properties: [classProperty],
  scale: 1
});



var trainedClassifier = ee.Classifier.smileRandomForest(300).train({
  features: training,
  classProperty: classProperty,
  inputProperties: image.bandNames()
});

// print(trainedClassifier);
var testpts = ee.FeatureCollection('users/erkere/marathonShapefiles/marathon_accuracy_testing').remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);
var testing = image.sampleRegions({collection: testpts, properties: [classProperty], scale: 1});
var testingClassified = testing.classify(trainedClassifier);
var testAccuracy = testingClassified.errorMatrix(classProperty, 'classification');
print('Testing error matrix: ', testAccuracy);
print('Testing overall accuracy: ', testAccuracy.accuracy());

// var valpts = ee.FeatureCollection('users/erkere/marathonShapefiles/marathon_accuracy_validation').remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);
// var validation = image.sampleRegions({collection: valpts, properties: [classProperty], scale: 1});
// var valClassified = validation.classify(trainedClassifier);
// var valAccuracy = valClassified.errorMatrix(classProperty, 'classification');
// print('Validation error matrix: ', valAccuracy);
// print('Validation overall accuracy: ', valAccuracy.accuracy());


var classified = image.classify(trainedClassifier);



Map.addLayer(naip05);
Map.addLayer(naip08);
Map.addLayer(naip10);
Map.addLayer(classified, {min: 0, max: 4, palette: ['yellow', 'red', 'brown','green','blue']});


Export.image.toDrive({
  image: classified,
  description: 'marathon-2010-fullcounty',
  scale: 1,
  region: marathonExport,
  maxPixels: 12000000000,
  crs: 'EPSG:3070'
});


Export.image.toAsset({
  image: classified,
  description: 'marathonClassified2010',
  assetId: 'marathonClassified2010',
  scale: 1,
  maxPixels: 12000000000,
  region: marathonExport,
  pyramidingPolicy: {
    'classification': 'mode'
  }
});

