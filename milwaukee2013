/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var grass = /* color: #eaed21 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-87.89279595081712, 43.043241601696934],
             [-87.89379373257066, 43.043123985841774],
             [-87.89386883442307, 43.043594447909506],
             [-87.89364352886582, 43.04419036134945],
             [-87.89571133639971, 43.03332252812635],
             [-87.89600101497332, 43.03234223065552],
             [-87.89512125041644, 43.032553976235036],
             [-87.92110807483607, 43.02939841628083],
             [-87.92113355582171, 43.029448414228774],
             [-87.92115233128482, 43.02937194676246],
             [-87.92108661716395, 43.029283714952165],
             [-87.92101285641604, 43.02927587211845],
             [-87.92098066990786, 43.029448414228774],
             [-87.92094311898165, 43.0293895931093],
             [-87.94337807558767, 43.02558209237983],
             [-87.94337807558767, 43.02563405426129],
             [-87.94336198233358, 43.02571836967346],
             [-87.9424822177767, 43.02589876505015],
             [-87.94245673679106, 43.02583797971071],
             [-87.94241248034231, 43.0259173928034],
             [-87.9429314877867, 43.02605366935268],
             [-87.94305218719236, 43.026051708541175],
             [-87.94316886328451, 43.02600268823299],
             [-87.94373078607313, 43.02508207957434],
             [-87.94368384741537, 43.02490364264598],
             [-87.94356717132322, 43.025282085185246]]),
        {
          "class_2013": 0,
          "system:index": "0"
        }),
    impervious = /* color: #ff1429 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-87.91399301411661, 43.02885974217624],
             [-87.91393936993632, 43.02917737829372],
             [-87.90637554051432, 43.02771859145308],
             [-87.9060107600883, 43.02789113794099],
             [-87.89947689892801, 43.02629898602833],
             [-87.89967001797709, 43.02716173356992],
             [-87.8993481528953, 43.025812704797914],
             [-87.90003479840311, 43.02856563319442]]),
        {
          "class_2013": 1,
          "system:index": "0"
        }),
    soil = /* color: #c2a042 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-87.90205207851092, 43.03016199294367],
             [-87.91629971386942, 43.02947932715305],
             [-87.91575254323038, 43.028683276956244],
             [-87.91520537259134, 43.02801270449353],
             [-87.93880051728034, 43.025756308327615],
             [-87.9389721786573, 43.02763866760804],
             [-87.94400168918364, 43.025175219523256],
             [-87.94392524622671, 43.02517325868367]]),
        {
          "class_2013": 2,
          "system:index": "0"
        }),
    tree = /* color: #20c82d */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-87.9214680826261, 43.028144541823664],
             [-87.92163706179404, 43.028207285621804],
             [-87.92140102740073, 43.02792689877678],
             [-87.92280114050651, 43.02723278876952],
             [-87.92295402642036, 43.027211220253726],
             [-87.92154586668754, 43.02729553349964],
             [-87.92144662495399, 43.02735435662587],
             [-87.92162633295798, 43.02767396129324],
             [-87.92179799433494, 43.02754455101492],
             [-87.92095578070426, 43.027917095017756],
             [-87.92131117339873, 43.02876707510712],
             [-87.92123741265083, 43.028782760903574],
             [-87.92111000772262, 43.028647470777294],
             [-87.92057222481513, 43.02869550860991],
             [-87.9203858112886, 43.02872393914618],
             [-87.92745745535636, 43.02848865155291],
             [-87.92784101124549, 43.0284435546612],
             [-87.92866981383109, 43.028314146005386],
             [-87.928653720577, 43.02814748294063],
             [-87.92905605192924, 43.02800434841795],
             [-87.92877441998267, 43.0280180736606],
             [-87.92925453539634, 43.028002387668735],
             [-87.92952812071586, 43.02802199515796],
             [-87.9279697572782, 43.02801415216301],
             [-87.92966431992559, 43.02653369251728],
             [-87.93021953719168, 43.02630035733203],
             [-87.93012565987615, 43.02600231446089],
             [-87.92989230769186, 43.02600231446089],
             [-87.92801476138143, 43.02607290369274],
             [-87.9281354607871, 43.02608859017767],
             [-87.94335125349753, 43.02542228480835],
             [-87.9433834400057, 43.02538895066123],
             [-87.94342501424543, 43.02540365690483],
             [-87.94338880442373, 43.02549679636583],
             [-87.9436717774748, 43.02511149220506],
             [-87.94362349771254, 43.025142865662275],
             [-87.94916292257982, 43.02248539703991],
             [-87.94914414711671, 43.023044258251545],
             [-87.94914951153474, 43.0232599577094],
             [-87.94642438717561, 43.02313249903044],
             [-87.94531931706148, 43.02223831993511],
             [-87.94564386435228, 43.02226577299588],
             [-87.94933726616578, 43.02198928089473],
             [-87.94917633362489, 43.02197555430406],
             [-87.9505469424315, 43.02186378052306],
             [-87.95109679527955, 43.021920647910754],
             [-87.95126309223848, 43.02191280413628],
             [-87.95121481247621, 43.022061835680056],
             [-87.95112898178773, 43.02208536694339],
             [-87.95085807867723, 43.02207360131285],
             [-87.95445407329035, 43.02209502680812],
             [-87.95389080939722, 43.02239308864928],
             [-87.95370841918421, 43.022498978691864],
             [-87.95266503987742, 43.02256368918353],
             [-87.95252020059061, 43.022561728260555],
             [-87.95267308650446, 43.02204796427986],
             [-87.95278573928309, 43.022000901715536]]),
        {
          "class_2013": 3,
          "system:index": "0"
        }),
    water = /* color: #0c00c2 */ee.Feature(
        ee.Geometry.MultiPoint(
            [[-87.89148990081125, 43.03252190097355],
             [-87.88936243694808, 43.01019918456226],
             [-87.87837610882308, 43.0005958218002],
             [-87.88035021465804, 43.00982261038359],
             [-87.88318262737776, 43.00649610486651],
             [-87.88747416180159, 43.019989302811986],
             [-87.89451227825667, 43.01506306019102],
             [-87.89262679603259, 43.03433025760413],
             [-87.89368895080248, 43.033365660855424],
             [-87.89704707648913, 43.03388325123975],
             [-87.89582398917834, 43.03529483919145],
             [-87.89584008243243, 43.03014630749968],
             [-87.94328822158568, 43.02575562528383],
             [-87.943347230184, 43.02566052539154],
             [-87.94333784245245, 43.0255634645248],
             [-87.94331370257132, 43.025374244414124],
             [-87.94321177862875, 43.02592621647404],
             [-87.94327615164511, 43.025847783801765],
             [-87.94325201176397, 43.025801704560095]]),
        {
          "class_2013": 4,
          "system:index": "0"
        });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var milwaukeeExport = ee.Geometry.Polygon(
        [[[-88.35575750089527, 43.35209206347098],
          [-88.35575750089527, 42.80743795582355],
          [-87.76249578214527, 42.80743795582355],
          [-87.76249578214527, 43.35209206347098]]], null, false),
    wb = ee.Image("users/erker/milwaukee/milwaukee_water/mke_water_bodies_26916_input"),
    wl = ee.Image("users/erker/milwaukee/milwaukee_water/mke_water_lines_26916_input");


var pts = ee.FeatureCollection('users/erker/milwaukee/milwaukee_shapefiles/milwaukee_accuracy_training');

var classProperty = 'class_2013';

var pts = pts.remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);


var testpts = ee.FeatureCollection('users/erker/milwaukee/milwaukee_shapefiles/milwaukee_accuracy_testing').filter(ee.Filter.neq(classProperty, '')).remap(['G','I','S','T','W'], [0,1,2,3,4], classProperty);
// var testpts = testpts.randomColumn();
// testpts =  testpts.filter(ee.Filter.lt('random', 0.2));
// print(testpts.size());



var buf3000 = function(feature) {return feature.buffer(3000)};
var urbanregion = testpts.map(buf3000);
var naip = ee.ImageCollection('USDA/NAIP/DOQQ').filterBounds(urbanregion); 
var naip13c = naip.filterDate('2013-01-01', '2013-12-31');
var naip15c = naip.filterDate('2015-01-01', '2015-12-31');



var naip13 = naip13c.median().byte();
var naip15 = naip15c.median().byte();


var ndvi13 = naip13.normalizedDifference(['N', 'R']);
var gauss53 = ee.Kernel.gaussian({radius: 5, sigma: 3, units: 'pixels', normalize:true});
var naip13Gauss53 = naip13.convolve(gauss53);

var gauss104 = ee.Kernel.gaussian({radius: 10, sigma: 4, units: 'pixels', normalize:true});
var naip13Gauss104 = naip13.convolve(gauss104);

var win10 = ee.Kernel.square({radius: 10});
var entro10 = naip13.select('N').entropy(win10);

var win5 = ee.Kernel.square({radius: 5});
var entro5 = naip13.select('N').entropy(win5);

var nir13glcm3 = naip13.select(['N']).glcmTexture({size: 3, average: false});
var contrast3 = nir13glcm3.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir13glcm7 = naip13.select(['N']).glcmTexture({size: 7, average: false});
var contrast7 = nir13glcm7.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');
var nir13glcm14 = naip13.select(['N']).glcmTexture({size: 14, average: false});
var contrast14 = nir13glcm14.select('N_contrast_-1_-1', 'N_contrast_0_-1', 'N_contrast_1_-1', 'N_contrast_-1_0');

// var image = ee.Image.cat([naip13, ndvi13, naip13Gauss53, entro10, entro5, contrast7, contrast14, wl, wb]);
// var image = naip13;
var image = ee.Image.cat([naip13, naip13Gauss53, entro5, contrast3, wl, wb]);
print(image);

// var training = image.sampleRegions({
//   collection: trainingData,
//   properties: [classProperty],
//   scale: 1
// });


var trainingGrass = image.sampleRegions({collection: grass, properties: [classProperty], scale: 1})
var trainingImpervious = image.sampleRegions({collection: impervious, properties: [classProperty], scale: 1})
var trainingSoil = image.sampleRegions({collection: soil, properties: [classProperty], scale: 1})
var trainingTree = image.sampleRegions({collection: tree, properties: [classProperty], scale: 1})
var trainingWater = image.sampleRegions({collection: water, properties: [classProperty], scale: 1})
var trainingPts = image.sampleRegions({collection: pts, properties: [classProperty], scale: 1});

var training = trainingPts.merge(trainingGrass).merge(trainingTree).merge(trainingSoil).merge(trainingImpervious).merge(trainingWater);
print(training.size());


var trainedClassifier = ee.Classifier.smileRandomForest(100).train({
  features: training,
  classProperty: classProperty,
  inputProperties: image.bandNames()
});

print(trainedClassifier);

var testing = image.sampleRegions({collection: testpts, properties: [classProperty], scale: 1});

var testClassified = testing.classify(trainedClassifier);
var testAccuracy = testClassified.errorMatrix(classProperty, 'classification');
print('testing error matrix: ', testAccuracy);
print('testing overall accuracy: ', testAccuracy.accuracy());


var classified = image.classify(trainedClassifier);

Map.addLayer(naip15);
Map.addLayer(naip13);
Map.addLayer(classified, {min: 0, max: 4, palette: ['yellow', 'red', 'brown','green','blue']});

//Map.addLayer(errors);

// // Export.image.toDrive({
// //   image: classified,
// //   description: 'marathon-2010-5',
// //   scale: 1,
// // });


// // Export.image.toDrive({
// //   image: classified,
// //   description: 'milwaukee-2010-fullcounty',
// //   scale: 1,
// //   maxPixels: 12000000000,
// //   crs: 'EPSG:3070'
// // });


// // Export.image.toAsset({
// //   image: classified,
// //   description: 'milwaukeeClassified2010',
// //   assetId: 'milwaukeeClassified2010',
// //   scale: 1,
// //   region: marathonExport,
// //   pyramidingPolicy: {
// //     'classification': 'mode'
// //   }
// // });